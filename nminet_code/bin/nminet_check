#!/bin/bash

CTL="timeout -t 10 -s KILL /opt/omneon/nmi/nminet/bin/nminetctl.py"

function check() {
	local opt=$1
	local RES

	$CTL $opt &> /dev/null
	RES=$?
	if [ $RES != 0 ]; then
		# something failed, try again
		sleep 3
		$CTL $opt &> /dev/null
		RES=$?
	fi

	return $RES

}

function failed() {
	local pid=`cat /var/run/nminet.pid`

	if [ -n "$pid" ]; then
		kill -USR1
	fi

	exit 1
}

# check that it's possible to retrieve status
check "status" || failed

# check that it's possible to retrieve XML config
check "status -c" || failed

exit 0
